<!DOCTYPE html> 
  <html>
    <head>
    <title>HealthKit iOS</title>
      </head>
    <body>
      <h1>HealthKit iOS</h1>
      <h2>Overview</h2>
      <p> HealthKit allows applications to connect to health and fitness data on iPhones and Apple Watches. 
        In order to use this data, users must give permission to the app to communicate with the HealthKit store. 
        In accessing this data, apps have the ability to read, share, or update the data stored in this central health storage system. 

        This basic app will integrate with the HealthKit to read and update the user’s step count. 
        It also creates a leaderboard of users with the highest step count, but that is beyond this basic HealthKit tutorial. 
    </p>
      <h2>Getting Started</h2>
      <p>Make sure you have XCode installed on your machine with a version that supports HealthKit. 
        HealthKit was introduced in iOS 8, so an XCode version that supports iOS version 8 or later will work. 
        You also need an active Apple Developer account to enable HealthKit capabilities.
      </p>
      <h2>
        Tutorial
      </h2>
      <p>
        To begin using HealthKit in your XCode project, you must do the following to configure your HealthKit store:
         <ol>1. Enable HealthKit in your project:
          In XCode, select the top folder of your project from the targets list
          Click on “Signing & Capabilities”
          Type in “HealthKit” and click on the search results
          Next, go to the “Info” tab
          Click the “+” and choose “Privacy - Health Share Usage Description”
          You can double click on the value column to enter your app’s purpose string. This lets the user know why you need access to this data.
          Finally, enable the Background Delivery capabilities
          You can also choose to access Clinical Health Records, 
          but see reference #2 in the See Also Section for more information about this as you need additional configuration steps. 
        </ol>
      <ol>2. Next, in the swift file that I wanted to access this HealthKit data (in my case MainViewController), 
        I used this line to import the HealthKit at the top:
      <pre>
      <code>
        import HealthKit
      </code>
      </pre>
      </ol>
      <ol>3. Then, within my class “MainViewController”, I added this near the top: 
      <code>private let healthStore = HKHealthStore()</code>
      </ol>
      <ol>4. Within my UI, I added labels as well as a progress bar and then put these outlets at the top of my MainViewController 
      <pre>
        <code>    
          @IBOutlet weak var stepsLabel: UILabel!
          @IBOutlet weak var loginLabel: UILabel!
          @IBOutlet weak var stepsProgress: UIProgressView!
          @IBOutlet weak var percentLabel: UILabel!
          @IBOutlet weak var updateStepsButton: UIButton!
        </code>
      </pre>
      </ol>
      <ol>5. In my function ViewDidLoad(), I added the following code (Note: we did not implement those two functions, so this will give errors):
      <pre>
      <code>override func viewDidLoad() {
        super.viewDidLoad()
        authorizeHealthKit() // This function provides the ability to authorize the HealthKit.
        gettingStepCount() { stepCount in // This function provides the step count of the users.
                    DispatchQueue.main.async {
                        print("Step count is:", Int(stepCount)) // Get the step count.
                        self.stepsLabel.text = "You have walked \(Int(stepCount)) steps!"
                        //these things do not update here...
                    }
        }
      }
      </code>
        </pre>
      </ol>
      <ol>6. To implement the authorizeHealthKit() function I added this:
        <pre>
        <code>
        private func authorizeHealthKit() {
          let healthKitTypes: Set = [ HKObjectType.quantityType(forIdentifier: HKQuantityTypeIdentifier.stepCount)! ] // We want to access the step count.
          healthStore.requestAuthorization(toShare: nil, read: healthKitTypes) { (success, error) in  // We will check the authorization.
            if success {} // Authorization is successful.
            }
          }
      </code>
      </pre>
      </ol>
      <ol>7. Next, let’s implement gettingStepCount() to get just the current day’s step count:
        <pre>
        <code>
        private func gettingStepCount(completion: @escaping (Double) -> Void) {
            var mSample = 0.0
            let type = HKQuantityType.quantityType(forIdentifier: .stepCount)!
       
            // Define the start and end date for the current day
            let calendar = Calendar.current
            let now = Date()
            let startOfDay = calendar.startOfDay(for: now)
            let endOfDay = calendar.date(bySettingHour: 23, minute: 59, second: 59, of: now)!
            // Create a predicate to filter samples for the current day
            let predicate = HKQuery.predicateForSamples(withStart: startOfDay, end: endOfDay, options: .strictStartDate)
            
            let sampleQuery = HKSampleQuery.init(sampleType: type,
                                                 predicate: predicate,
                                                 limit: HKObjectQueryNoLimit,
                                                 sortDescriptors: nil,
                                                 resultsHandler: { (query, results, error) in
                
                guard let samples = results as? [HKQuantitySample] else {
                    print(error!)
                    return
                }
                for sample in samples {
                    mSample = mSample + sample.quantity.doubleValue(for: HKUnit(from: "count"))
                }
                print("Step count : \(mSample)")
                DispatchQueue.main.async {
                    print("Step count is:", Int(mSample)) // Get the step count.
                    self.stepsLabel.text = "You have walked \(Int(mSample)) steps today!"
                    let progressPercent: Float = Float(mSample/10000)
                    self.percentLabel.text = "\(Int(mSample))/10,000 steps = \(Float(progressPercent*100))% of goal!"
                    self.stepsProgress.setProgress(progressPercent, animated: false)
                    self.numSteps = Int(mSample)
                    // here is where to update the step count labels/info                      
                }
            })
            self.healthStore .execute(sampleQuery)
        }
      </code>
      </pre>
      </ol>
      <ol>8. Finally, I implemented a “Update Steps” button in my UI with the outlet listed in #4. Let’s create an update when that button is clicked:
        <pre><code>
        @IBAction func updateStepsButtonPressed(_ sender: Any) {
          gettingStepCount() { stepCount in // This function provides to get the step count of the users.
                      DispatchQueue.main.async {
                          print("Step count is:", Int(stepCount)) // Get the step count.                  
                      }
            }
          }
        </code></pre>
      </ol>
      <ol>9. Make sure the outlets are connected to the UI, so the labels are correctly updated! 
        This will give you step count, but if you look at the HealthKit documentation, you can use other data from the HealthKit store.
      </ol>
      <h2>Further Discussion/Conclusions:</h2>
        If you followed along, you should have successfully implemented the HealthKit in your application! 
        You can now track the user’s step count and update that count within your app. 
        You can also look into the HealthKit documentation to see how you can update the HeathKit data from your app. 

        If you want to access real-time data, including pedometer functionality, look into Apple’s Core Motion Framework. 

        Here is our complete source code on GitHub.
      </p>
      
    </body>
  </html>
